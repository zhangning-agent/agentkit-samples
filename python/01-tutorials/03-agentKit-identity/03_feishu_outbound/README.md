# å®éªŒ3 (è¿›é˜¶): è®©æ™ºèƒ½ä½“å®‰å…¨è®¿é—®é£ä¹¦æ–‡æ¡£

> å‡­è¯æ‰˜ç®¡ + OAuth2.0 ä¸‰æ–¹æˆæƒ + AgentKit Runtime éƒ¨ç½²

âš ï¸ **é‡è¦è¯´æ˜**ï¼šæœ¬æ•™ç¨‹æ˜¯**è¿›é˜¶æ•™ç¨‹**ï¼Œéœ€è¦éƒ¨ç½²åˆ° AgentKit Runtime æ‰èƒ½å®Œæ•´è¿è¡Œã€‚
è¿™æ˜¯å› ä¸º **Outbound å‡­è¯æ‰˜ç®¡** ä¾èµ– **å·¥ä½œè´Ÿè½½èº«ä»½ (Workload Identity)**ï¼Œ
è€Œå·¥ä½œè´Ÿè½½èº«ä»½åªæœ‰åœ¨ AgentKit Runtime ä¸­æ‰ä¼šè‡ªåŠ¨åˆ†é…ã€‚

---

## ä¸šåŠ¡åœºæ™¯

æƒ³è±¡è¿™æ ·çš„åœºæ™¯ï¼š

> ç”¨æˆ·å¯¹ Agent è¯´ï¼š"å¸®æˆ‘æ€»ç»“ä¸€ä¸‹é‚£ä¸ªé£ä¹¦æ–‡æ¡£çš„å†…å®¹"
>
> Agent éœ€è¦è®¿é—®ç”¨æˆ·çš„é£ä¹¦æ–‡æ¡£ï¼Œä½†æ˜¯...
> - **é£ä¹¦ API éœ€è¦æˆæƒ**
> - **æ¯ä¸ªç”¨æˆ·çš„æˆæƒæ˜¯ç‹¬ç«‹çš„**
> - **å‡­è¯æ€ä¹ˆå®‰å…¨ç®¡ç†ï¼Ÿ**

### ä¼ ç»Ÿæ–¹æ¡ˆçš„é—®é¢˜

| æ–¹æ¡ˆ | é—®é¢˜ |
|------|------|
| **ç¡¬ç¼–ç å‡­è¯** | AK/SK å†™åœ¨ä»£ç é‡Œï¼Œæ³„éœ²é£é™©æé«˜ |
| **å…±äº«å‡­è¯** | æ‰€æœ‰ç”¨æˆ·ç”¨åŒä¸€ä¸ª Tokenï¼Œæ— æ³•è¿½æº¯è°åšäº†ä»€ä¹ˆ |
| **æ‰‹åŠ¨ç®¡ç†** | æ¯ä¸ªç”¨æˆ·å•ç‹¬ç®¡ç† Tokenï¼Œè¿ç»´æˆæœ¬çˆ†ç‚¸ |
| **Token è¿‡æœŸ** | æ‰‹åŠ¨åˆ·æ–° Tokenï¼Œç”¨æˆ·ä½“éªŒå·® |

---

## Agent Identity è§£å†³æ–¹æ¡ˆ

### å‡­è¯æ‰˜ç®¡ (Credential Provider)

```mermaid
flowchart LR
    A[ğŸ‘¤ ç”¨æˆ·] --> B[ğŸ¤– Agent]
    B --> C[ğŸ” å‡­è¯æ‰˜ç®¡æœåŠ¡]
    C --> D[ğŸ“± é£ä¹¦ API]

    C --> E[Token Vault<br/>ç”¨æˆ·çº§éš”ç¦»]
    E --> E1[ç”¨æˆ·A Token]
    E --> E2[ç”¨æˆ·B Token]
    E --> E3[ç”¨æˆ·C Token]

    B -.->|é¦–æ¬¡ä½¿ç”¨è§¦å‘æˆæƒ<br/>åç»­æ— æ„Ÿä½¿ç”¨| C

    style C fill:#e6f3ff
    style E fill:#fff3e6
```

### æ ¸å¿ƒä¼˜åŠ¿

| ç‰¹æ€§ | è¯´æ˜ |
|------|------|
| **å‡­è¯ä¸è½åœ°** | AK/SK ç”±å¹³å°ç»Ÿä¸€ç®¡ç†ï¼Œä¸åœ¨ä»£ç ä¸­å‡ºç° |
| **ç”¨æˆ·çº§éš”ç¦»** | æ¯ä¸ªç”¨æˆ·çš„é£ä¹¦æˆæƒç‹¬ç«‹ç®¡ç† |
| **OAuth è‡ªåŠ¨åŒ–** | é¦–æ¬¡ä½¿ç”¨å¼•å¯¼æˆæƒï¼Œåç»­è‡ªåŠ¨åˆ·æ–° Token |
| **å®‰å…¨å®¡è®¡** | æ‰€æœ‰å‡­è¯ä½¿ç”¨éƒ½æœ‰è®°å½• |
| **å·¥ä½œè´Ÿè½½èº«ä»½** | AgentKit Runtime è‡ªåŠ¨åˆ†é…ï¼Œæ— éœ€æ‰‹åŠ¨é…ç½® |

---

## OAuth å®Œæ•´æµç¨‹è¯¦è§£

> âš ï¸ **ç†è§£è¿™ä¸ªæµç¨‹æ˜¯é¿å…è¸©å‘çš„å…³é”®ï¼**

```mermaid
sequenceDiagram
    autonumber
    participant U as ğŸ‘¤ ç”¨æˆ·
    participant A as ğŸ¤– AgentKit Runtime
    participant I as ğŸ” Identity Service
    participant F as ğŸ“± é£ä¹¦

    U->>A: "æŸ¥è¯¢é£ä¹¦æ–‡æ¡£"
    A->>I: è¯·æ±‚ Token

    rect rgba(255, 200, 200, 0.2)
        Note over I: æ£€æŸ¥ Token Vault
        alt å·²æˆæƒ
            I-->>A: è¿”å› access_token
        else æœªæˆæƒ
            I-->>A: è¿”å› authorization_url
        end
    end

    A-->>U: å±•ç¤ºæˆæƒé“¾æ¥
    U->>F: ç‚¹å‡»æˆæƒé“¾æ¥ï¼Œæ‰“å¼€é£ä¹¦æˆæƒé¡µé¢
    U->>F: åŒæ„æˆæƒ

    rect rgba(200, 255, 200, 0.2)
        Note over F,I: âš ï¸ å›è°ƒ URL å¿…é¡»æ˜¯ Identity Service ç«¯ç‚¹
        F->>I: é‡å®šå‘åˆ°å›è°ƒ URL (å¸¦ code)
        I->>F: ç”¨ code æ¢å– access_token
        F-->>I: è¿”å› access_token
        Note over I: å­˜å‚¨ Token åˆ° Token Vaultï¼ˆç”¨æˆ·çº§éš”ç¦»ï¼‰
    end

    A->>I: è½®è¯¢è·å– Token
    I-->>A: è¿”å› access_token
    A->>F: ä½¿ç”¨ Token è°ƒç”¨é£ä¹¦ API
    F-->>A: è¿”å›æ–‡æ¡£å†…å®¹
    A-->>U: è¿”å›ç»“æœ
```

### ğŸ”´ å…³é”®é…ç½®ç‚¹

| é…ç½®é¡¹ | æ­£ç¡®å€¼ | å¸¸è§é”™è¯¯ |
|--------|--------|----------|
| **å‡­è¯æä¾›è€…å›è°ƒ URL** | `https://auth.id.cn-beijing.volces.com/api/v1/oauth2callback` | âŒ é”™è¯¯åœ°è®¾ä¸º Runtime URLï¼ˆä¼šå¯¼è‡´ "Consumer authentication failed"ï¼‰ |
| **é£ä¹¦å®‰å…¨è®¾ç½®é‡å®šå‘ URL** | `https://auth.id.cn-beijing.volces.com/api/v1/oauth2callback` | âŒ åªæ·»åŠ äº†æœ¬åœ°å¼€å‘ URL |
| **é£ä¹¦æƒé™èŒƒå›´** | `drive:drive,docx:document:readonly,offline_access` | âŒ ä½¿ç”¨ `openid` ç­‰æ ‡å‡† OIDC scopeï¼ˆé£ä¹¦ä¸æ”¯æŒï¼‰ |

---

## è¿è¡Œç¯å¢ƒè¯´æ˜

æœ¬æ•™ç¨‹çš„ **Outbound å‡­è¯æ‰˜ç®¡** åŠŸèƒ½ä¾èµ– **å·¥ä½œè´Ÿè½½èº«ä»½ (Workload Identity)**ï¼š

| ç¯å¢ƒ | å·¥ä½œè´Ÿè½½èº«ä»½ | å‡­è¯æ‰˜ç®¡åŠŸèƒ½ |
|------|-------------|-------------|
| æœ¬åœ° veadk web | âš ï¸ éœ€æ‰‹åŠ¨é…ç½® | âœ… å¯æµ‹è¯• |
| AgentKit Runtime | âœ… è‡ªåŠ¨åˆ†é… | âœ… å®Œæ•´æ”¯æŒ |

### æœ¬åœ°å¼€å‘æ¨¡å¼

æœ¬æ•™ç¨‹**æ”¯æŒæœ¬åœ°è¿è¡Œæµ‹è¯•**ï¼Œé€šè¿‡ `RUNTIME_IAM_ROLE_TRN` ç¯å¢ƒå˜é‡æ¨¡æ‹Ÿå·¥ä½œè´Ÿè½½èº«ä»½ï¼š

```bash
# åœ¨ .env ä¸­é…ç½®
RUNTIME_IAM_ROLE_TRN=trn:iam::<account_id>:role/<role_name>
```

> âš ï¸ **å‰ææ¡ä»¶**ï¼šä½ çš„ AK/SK å¿…é¡»æœ‰æƒé™ AssumeRole åˆ°æŒ‡å®šçš„ IAM Roleï¼Œä¸”è¯¥ Role éœ€å…·å¤‡ `IDReadOnly` æƒé™ã€‚

---

## å¿«é€Ÿå¼€å§‹

### å‰ç½®æ¡ä»¶

1. **å®ŒæˆåŸºç¡€æ•™ç¨‹**
   - å®Œæˆå®éªŒ1çš„ç”¨æˆ·æ± åˆ›å»ºå’Œå®¢æˆ·ç«¯é…ç½®
   - å®Œæˆå®éªŒ2çš„é£ä¹¦åº”ç”¨åˆ›å»ºï¼ˆå¯å¤ç”¨ï¼‰

2. **å®‰è£… AgentKit CLI**
   ```bash
   pip install agentkit-cli
   ```

3. **é…ç½® AgentKit**
   ```bash
   agentkit config --tos_bucket <your-bucket-name>
   ```

---

### æ­¥éª¤1: é…ç½®é£ä¹¦åº”ç”¨ï¼ˆç”¨äºæ–‡æ¡£è®¿é—®ï¼‰

> **è¯´æ˜**ï¼šå¯ä»¥å¤ç”¨å®éªŒ2åˆ›å»ºçš„é£ä¹¦åº”ç”¨ï¼Œä½†éœ€è¦æ·»åŠ æ–‡æ¡£è®¿é—®æƒé™ã€‚

1. **ç™»å½•é£ä¹¦å¼€æ”¾å¹³å°**

   è®¿é—® [é£ä¹¦å¼€æ”¾å¹³å°](https://open.feishu.cn/)

2. **è·å–åº”ç”¨å‡­è¯**

   è¿›å…¥ã€Œå‡­è¯ä¸åŸºç¡€ä¿¡æ¯ã€ï¼Œè®°å½•ï¼š
   - **App ID**
   - **App Secret**

3. **âš ï¸ é…ç½®å®‰å…¨è®¾ç½®ï¼ˆé‡å®šå‘ URLï¼‰**

   è¿›å…¥ã€Œå®‰å…¨è®¾ç½®ã€â†’ æ·»åŠ é‡å®šå‘ URLï¼š

   > **é‡è¦ï¼šå‡­è¯æ‰˜ç®¡ä½¿ç”¨ä¸åŒçš„å›è°ƒ URLï¼**
   > ```
   > https://auth.id.cn-beijing.volces.com/api/v1/oauth2callback
   > ```
![alt text](./assets/images/image.png)
4. **âš ï¸ æ·»åŠ æ–‡æ¡£è®¿é—®æƒé™ï¼ˆå…³é”®æ­¥éª¤ï¼ï¼‰**

   è¿›å…¥ã€Œæƒé™ç®¡ç†ã€â†’ æœç´¢å¹¶ç”³è¯·ä»¥ä¸‹æƒé™ï¼š

   | æƒé™ | è¯´æ˜ | æ˜¯å¦å¿…é¡» |
   |------|------|----------|
   | `docx:document:readonly` | æŸ¥çœ‹ã€ä¸‹è½½äº‘æ–‡æ¡£ | âœ… å¿…é¡» |
   | `drive:drive` | æŸ¥çœ‹äº‘ç©ºé—´ | âœ… å¿…é¡» |
   | `docs:document.content:read` | è¯»å–æ–‡æ¡£å†…å®¹ | âœ… æ¨è |

5. **å‘å¸ƒåº”ç”¨**

   å®Œæˆé…ç½®åï¼Œç‚¹å‡»ã€Œåˆ›å»ºç‰ˆæœ¬å¹¶å‘å¸ƒã€ä½¿åº”ç”¨ç”Ÿæ•ˆã€‚

---

### æ­¥éª¤2: åˆ›å»ºå‡­è¯æä¾›è€…ï¼ˆCredential Providerï¼‰

> **è¿™æ˜¯æœ¬æ•™ç¨‹çš„æ ¸å¿ƒæ­¥éª¤ï¼** åœ¨ Agent Identity æ§åˆ¶å°åˆ›å»ºé£ä¹¦å‡­è¯æä¾›è€…ã€‚

1. **è®¿é—®å‡­è¯æ‰˜ç®¡æ§åˆ¶å°**

   æ‰“å¼€ [Agent Identity æ§åˆ¶å° â†’ å‡­è¯ç®¡ç†](https://console.volcengine.com/identity/region:identity+cn-beijing/outbound-credentials)

2. **åˆ›å»ºå‡­è¯æä¾›è€…**

   ç‚¹å‡»ã€Œåˆ›å»ºå‡­è¯æä¾›è€…ã€ï¼Œå¡«å†™ä»¥ä¸‹ä¿¡æ¯ï¼š

   | å­—æ®µ | å€¼ | è¯´æ˜ |
   |------|------|------|
   | æä¾›è€…åç§° | `feishu` æˆ–è‡ªå®šä¹‰ | ä»£ç ä¸­ä¼šç”¨åˆ°è¿™ä¸ªåç§° |
   | æä¾›è€…ç±»å‹ | OAuth 2.0 | é€‰æ‹© OAuth 2.0 |
   | æœåŠ¡å•† | é£ä¹¦ | é€‰æ‹©é£ä¹¦ |
   | Client ID | æ­¥éª¤1è·å–çš„ App ID | ä»é£ä¹¦åº”ç”¨å‡­è¯å¤åˆ¶ |
   | Client Secret | æ­¥éª¤1è·å–çš„ App Secret | ä»é£ä¹¦åº”ç”¨å‡­è¯å¤åˆ¶ |
![alt text](./assets/images/image-1.png)
3. **âš ï¸ é…ç½®å…³é”®å‚æ•°ï¼ˆé¿å‘é‡ç‚¹ï¼ï¼‰**

   | å­—æ®µ | æ­£ç¡®é…ç½® | è¯´æ˜ |
   |------|----------|------|
   | **OAuth2 æµç¨‹** | `USER_FEDERATION` | ç”¨æˆ·çº§ä¸‰æ–¹æˆæƒ |
   | **å›è°ƒ URL** | `https://auth.id.cn-beijing.volces.com/api/v1/oauth2callback` | âš ï¸ **å¿…é¡»æ˜¯ Identity Service çš„ç«¯ç‚¹ï¼** |
   | **æƒé™èŒƒå›´** | `drive:drive,docx:document:readonly,offline_access` | é£ä¹¦æ–‡æ¡£è¯»å–æƒé™ |
   | **æ™ºèƒ½ä½“èº«ä»½æ± ** | `default` | é»˜è®¤å·¥ä½œè´Ÿè½½æ±  |

   > ğŸš¨ **å¸¸è§é”™è¯¯**ï¼š
   > - âŒ å›è°ƒ URL è®¾ä¸º Runtime çš„ URLï¼ˆå¦‚ `https://xxx.apigateway-cn-beijing.volceapi.com/...`ï¼‰
   > - âŒ æƒé™èŒƒå›´ä½¿ç”¨ `openid`ã€`profile` ç­‰æ ‡å‡† OIDC scopeï¼ˆé£ä¹¦ä¸æ”¯æŒï¼‰
![alt text](./assets/images/image-2.png)
4. **éªŒè¯é…ç½®**

   ç‚¹å‡»ã€Œæµ‹è¯•ã€æŒ‰é’®éªŒè¯ OAuth æµç¨‹ï¼š
   - âœ… æˆåŠŸï¼šèƒ½è·³è½¬åˆ°é£ä¹¦æˆæƒé¡µï¼Œæˆæƒåèƒ½è·å– Token
   - âŒ å¤±è´¥ï¼šæ£€æŸ¥å›è°ƒ URL å’Œæƒé™èŒƒå›´é…ç½®
![alt text](./assets/images/image-3.png)
5. **ä¿å­˜é…ç½®**

   è®°ä½å‡­è¯æä¾›è€…åç§°ï¼ˆå¦‚ `feishu`ï¼‰ï¼Œåç»­é…ç½®æ—¶éœ€è¦ä½¿ç”¨ã€‚

---

### æ­¥éª¤3: é…ç½®ç¯å¢ƒå˜é‡

```bash
# è¿›å…¥æ•™ç¨‹ç›®å½•
cd python/01-tutorials/03-agentKit-identity/03_feishu_outbound

# å¤åˆ¶ç¯å¢ƒå˜é‡æ¨¡æ¿
cp .env.example .env
```

ç¼–è¾‘ `.env` æ–‡ä»¶ï¼š

```bash
# ==================== ç”¨æˆ·æ± è®¤è¯é…ç½® ====================
# ä¸å®éªŒ1/2ç›¸åŒ
ADK_OAUTH2_USERPOOL_UID=your-userpool-uid
ADK_OAUTH2_CLIENT_ID=your-client-id
ADK_OAUTH2_CLIENT_SECRET=your-client-secret
ADK_OAUTH2_CALLBACK_URL=http://127.0.0.1:8000/oauth2/callback  # æ³¨æ„ï¼šæ–°ç‰ˆæœ¬ä½¿ç”¨ /oauth2/callback
ADK_OAUTH2_SCOPE=openid profile

# ==================== ç«å±±äº‘å‡­è¯ ====================
VOLCENGINE_ACCESS_KEY=your-access-key
VOLCENGINE_SECRET_KEY=your-secret-key

# ==================== å‡­è¯æä¾›è€…é…ç½® ====================
# æœ¬ç¤ºä¾‹åŒæ—¶æ”¯æŒ GitHub å’Œé£ä¹¦ï¼Œåˆ†åˆ«é…ç½®
GITHUB_CREDENTIAL_PROVIDER=github_oauth   # GitHub å‡­è¯æä¾›è€…åç§°
FEISHU_CREDENTIAL_PROVIDER=feishu_oauth   # é£ä¹¦å‡­è¯æä¾›è€…åç§°

# ==================== æœ¬åœ°è¿è¡Œé…ç½® ====================
# ç”¨äºæœ¬åœ°æ¨¡æ‹Ÿ Workload Identityï¼ˆæœ¬åœ°æµ‹è¯•å¿…éœ€ï¼ï¼‰
RUNTIME_IAM_ROLE_TRN=trn:iam::<account_id>:role/<role_name>
```

> âš ï¸ **é‡è¦æç¤º**ï¼š
>
> - `ADK_OAUTH2_CALLBACK_URL` æ–°ç‰ˆæœ¬ veadk ä½¿ç”¨ `/oauth2/callback`ï¼Œéœ€è¦ä¸ç”¨æˆ·æ± å®¢æˆ·ç«¯é…ç½®ä¸€è‡´
> - `RUNTIME_IAM_ROLE_TRN` æ˜¯æœ¬åœ°æµ‹è¯•å¿…éœ€çš„ï¼ŒæŒ‡å®šä¸€ä¸ªä½ æœ‰æƒé™ AssumeRole ä¸”å…·å¤‡ `IDReadOnly` æƒé™çš„ IAM Role
> - Shell ç¯å¢ƒå˜é‡ä¼˜å…ˆçº§é«˜äº .env æ–‡ä»¶ï¼Œç¡®ä¿ `~/.zshrc` æˆ– `~/.bashrc` ä¸­çš„ AK/SK ä¸ .env ä¸€è‡´

---

### æ­¥éª¤4: æœ¬åœ°è¿è¡Œæµ‹è¯•ï¼ˆæ¨èå…ˆæµ‹è¯•ï¼‰

åœ¨éƒ¨ç½²åˆ° Runtime ä¹‹å‰ï¼Œå»ºè®®å…ˆåœ¨æœ¬åœ°æµ‹è¯•ï¼š

```bash
# å®‰è£…ä¾èµ–
uv sync

# æœ¬åœ°å¯åŠ¨æœåŠ¡
uv run veadk web
```

è®¿é—® <http://127.0.0.1:8000> è¿›è¡Œæµ‹è¯•ã€‚

> âš ï¸ **æœ¬åœ°æµ‹è¯•æ³¨æ„äº‹é¡¹**ï¼š
>
> 1. ç¡®ä¿ `.env` ä¸­é…ç½®äº† `RUNTIME_IAM_ROLE_TRN`
> 2. ç¡®ä¿ä½ çš„ AK/SK æœ‰æƒé™ AssumeRole åˆ°æŒ‡å®šçš„ Role
> 3. å¦‚æœé‡åˆ° `AssumeRole 403` é”™è¯¯ï¼Œæ£€æŸ¥ç»ˆç«¯ç¯å¢ƒå˜é‡æ˜¯å¦ä¸ .env ä¸€è‡´ï¼ˆ**å¼€æ–°ç»ˆç«¯**ï¼‰

---

### æ­¥éª¤5: éƒ¨ç½²åˆ° AgentKit Runtimeï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

æœ¬åœ°æµ‹è¯•é€šè¿‡åï¼Œéƒ¨ç½²åˆ° AgentKit Runtimeï¼š

```bash
# éƒ¨ç½²åˆ° AgentKit Runtime
agentkit launch
```

éƒ¨ç½²æˆåŠŸåï¼Œä¼šè¾“å‡º Agent çš„è®¿é—®åœ°å€ã€‚

---

### æ­¥éª¤6: æµ‹è¯•å‡­è¯æ‰˜ç®¡

1. **è®¿é—®éƒ¨ç½²åçš„ Agent**

   ä½¿ç”¨ `agentkit launch` è¾“å‡ºçš„ URL è®¿é—® Agentã€‚

2. **ç™»å½•å¹¶å‘é€è¯·æ±‚**

   åœ¨å¯¹è¯æ¡†ä¸­è¾“å…¥ï¼š
   ```
   ä¸ºæˆ‘æ€»ç»“æ–‡æ¡£å†…å®¹ï¼šhttps://feishu.feishu.cn/docx/xxxxxxxxxxxxxxxx
   ```

   > **æç¤º**ï¼šæ›¿æ¢ä¸ºä½ æœ‰æƒé™è®¿é—®çš„é£ä¹¦æ–‡æ¡£ URL

3. **é¦–æ¬¡æˆæƒ**

   ç³»ç»Ÿä¼šè‡ªåŠ¨è·³è½¬åˆ°é£ä¹¦æˆæƒé¡µé¢ï¼š
   - ç‚¹å‡»ã€Œæˆæƒã€æŒ‰é’®
   - æˆæƒå®Œæˆåè‡ªåŠ¨è¿”å›åº”ç”¨

4. **æŸ¥çœ‹ç»“æœ**

   æˆæƒæˆåŠŸåï¼ŒAgent ä¼šè¿”å›æ–‡æ¡£æ‘˜è¦ã€‚

```mermaid
flowchart LR
    subgraph é¦–æ¬¡ä½¿ç”¨
        A1[ç”¨æˆ·è¯·æ±‚] --> A2[Agent éœ€è¦å‡­è¯]
        A2 --> A3[è§¦å‘é£ä¹¦æˆæƒ]
        A3 --> A4[ç”¨æˆ·æˆæƒ]
        A4 --> A5[è·å– Token]
        A5 --> A6[è®¿é—®æ–‡æ¡£]
    end

    subgraph åç»­ä½¿ç”¨
        B1[ç”¨æˆ·è¯·æ±‚] --> B2[Agent ä½¿ç”¨ç¼“å­˜ Token]
        B2 --> B3[ç›´æ¥è®¿é—®æ–‡æ¡£<br/>ç”¨æˆ·æ— æ„ŸçŸ¥]
    end

    style A3 fill:#ffffcc
    style B2 fill:#ccffcc
```

---

## æµ‹è¯•æç¤ºè¯

```
# æŸ¥è¯¢æ–‡æ¡£
ä¸ºæˆ‘æ€»ç»“æ–‡æ¡£å†…å®¹ï¼š<é£ä¹¦æ–‡æ¡£URL>

# ç»§ç»­æé—®
è¿™ä¸ªæ–‡æ¡£çš„ä¸»è¦å†…å®¹æ˜¯ä»€ä¹ˆï¼Ÿ

# æ¸…ç†å‡­è¯ï¼ˆå¦‚éœ€é‡æ–°æˆæƒæµ‹è¯•ï¼‰
æ¸…ç†æˆ‘çš„èº«ä»½å‡­æ®
```
![alt text](./assets/images/image-8.png)
![alt text](./assets/images/image-9.png)
![alt text](./assets/images/image-10.png)

## å¸¸è§é—®é¢˜æ’æŸ¥

### é”™è¯¯é€ŸæŸ¥è¡¨

| é”™è¯¯/ç°è±¡ | åŸå›  | è§£å†³æ–¹æ³• |
|-----------|------|----------|
| **Consumer authentication failed** | å›è°ƒ URL é…ç½®é”™è¯¯ï¼ŒæŒ‡å‘äº†éœ€è¦è®¤è¯çš„ Runtime ç«¯ç‚¹ | å°†å‡­è¯æä¾›è€…çš„å›è°ƒ URL æ”¹ä¸º `https://auth.id.cn-beijing.volces.com/api/v1/oauth2callback` |
| **redirect_uri is missing** | ç”¨æˆ·æ± å®¢æˆ·ç«¯ç¼ºå°‘å›è°ƒ URL é…ç½® | åœ¨ç”¨æˆ·æ± å®¢æˆ·ç«¯æ·»åŠ å›è°ƒ URL |
| **Error 20043: openid æœ‰è¯¯** | é£ä¹¦ä¸æ”¯æŒæ ‡å‡† OIDC scope | ä½¿ç”¨é£ä¹¦ç‰¹å®š scopeï¼š`drive:drive,docx:document:readonly` |
| æˆæƒé¡µé¢æŠ¥é”™ redirect_uri | é£ä¹¦å®‰å…¨è®¾ç½®ç¼ºå°‘å‡­è¯æ‰˜ç®¡å›è°ƒ URL | åœ¨é£ä¹¦ã€Œå®‰å…¨è®¾ç½®ã€æ·»åŠ  `https://auth.id.cn-beijing.volces.com/api/v1/oauth2callback` |
| æç¤ºæƒé™ä¸è¶³ | é£ä¹¦åº”ç”¨æœªç”³è¯·æ–‡æ¡£è¯»å–æƒé™ | åœ¨é£ä¹¦ã€Œæƒé™ç®¡ç†ã€ç”³è¯· `docx:document:readonly` |
| æ‰¾ä¸åˆ°å‡­è¯æä¾›è€… | æœªåˆ›å»º Credential Provider | åœ¨æ§åˆ¶å°åˆ›å»ºå¯¹åº”çš„å‡­è¯æä¾›è€… |
| Token å¤±æ•ˆ | Token è¿‡æœŸæˆ–è¢«æ’¤é”€ | è¾“å…¥"æ¸…ç†æˆ‘çš„èº«ä»½å‡­æ®"é‡æ–°æˆæƒ |
| GetWorkloadAccessToken å¤±è´¥ | æœªéƒ¨ç½²åˆ° AgentKit Runtime | **å¿…é¡»**éƒ¨ç½²åˆ° AgentKit Runtime æ‰èƒ½ä½¿ç”¨å‡­è¯æ‰˜ç®¡ |

### ğŸ”´ æœ¬åœ°å¼€å‘å¸¸è§é—®é¢˜

ä»¥ä¸‹æ˜¯åœ¨æœ¬åœ°ä½¿ç”¨ `veadk web` æµ‹è¯•æ—¶çš„å¸¸è§é—®é¢˜ï¼š

#### 1. AssumeRole 403 NoPermission

**é”™è¯¯ä¿¡æ¯**ï¼š

```text
AssumeRole: NoPermission - You have no permission for this action.
```

**åŸå› **ï¼šShell ç¯å¢ƒå˜é‡ä¸­çš„ AK/SK ä¸ .env æ–‡ä»¶ä¸­çš„ä¸ä¸€è‡´ï¼Œå¯¼è‡´æ²¡æœ‰æƒé™ AssumeRoleã€‚

**æ’æŸ¥æ–¹æ³•**ï¼š

```bash
# æ£€æŸ¥å½“å‰ç»ˆç«¯çš„ç¯å¢ƒå˜é‡
echo $VOLCENGINE_ACCESS_KEY

# æ£€æŸ¥ .env æ–‡ä»¶ä¸­çš„é…ç½®
cat .env | grep VOLCENGINE_ACCESS_KEY
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

- ç¡®ä¿ `~/.zshrc` æˆ– `~/.bashrc` ä¸­çš„ AK/SK ä¸ .env æ–‡ä»¶ä¸€è‡´
- æˆ–è€…å¼€ä¸€ä¸ª**æ–°ç»ˆç«¯**çª—å£é‡æ–°è¿è¡ŒæœåŠ¡
- âš ï¸ **Shell ç¯å¢ƒå˜é‡ä¼˜å…ˆçº§é«˜äº .env æ–‡ä»¶**ï¼Œå¦‚æœç¯å¢ƒå˜é‡å·²è®¾ç½®ï¼Œä¼šè¦†ç›– .env ä¸­çš„å€¼

#### 2. GetWorkloadAccessTokenForUserId: "Name is missing or invalid"

**é”™è¯¯ä¿¡æ¯**ï¼š

```text
InvalidParameter: Name is missing or invalid
```

**åŸå› **ï¼šå‡­è¯æä¾›è€…åç§°é…ç½®ä¸æ­£ç¡®ã€‚

**æ’æŸ¥æ–¹æ³•**ï¼š

1. æ£€æŸ¥ä»£ç ä¸­ä½¿ç”¨çš„ç¯å¢ƒå˜é‡åç§°ï¼ˆæœ¬ç¤ºä¾‹ä½¿ç”¨ `FEISHU_CREDENTIAL_PROVIDER`ï¼‰
2. ç¡®è®¤ Agent Identity æ§åˆ¶å°ä¸­å‡­è¯æä¾›è€…çš„åç§°ä¸é…ç½®ä¸€è‡´

**è§£å†³æ–¹æ¡ˆ**ï¼š

```bash
# åœ¨ .env ä¸­æ·»åŠ 
FEISHU_CREDENTIAL_PROVIDER=feishu_oauth  # æ”¹ä¸ºä½ åˆ›å»ºçš„å‡­è¯æä¾›è€…åç§°
```

#### 3. Missing authorization code or state

**é”™è¯¯ä¿¡æ¯**ï¼š

```text
detail: "Missing authorization code or state"
```

**åŸå› **ï¼šOAuth å›è°ƒ URL ä¸åŒ¹é…ã€‚veadk è¾ƒæ–°ç‰ˆæœ¬å¯èƒ½ä½¿ç”¨ `/oauth2/callback` è€Œé `/api/v1/oauth2callback`ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. åœ¨ç”¨æˆ·æ± æ§åˆ¶å°çš„**å®¢æˆ·ç«¯é…ç½®**ä¸­ï¼Œå°†å›è°ƒ URL æ”¹ä¸ºï¼š

   ```text
   http://127.0.0.1:8000/oauth2/callback
   ```

2. åŒæ­¥æ›´æ–° .env æ–‡ä»¶ï¼š

   ```bash
   ADK_OAUTH2_CALLBACK_URL=http://127.0.0.1:8000/oauth2/callback
   ```

3. é‡å¯ veadk web æœåŠ¡

#### 4. é£ä¹¦ 20029 redirect_uri è¯·æ±‚ä¸åˆæ³•

**é”™è¯¯ä¿¡æ¯**ï¼š

```text
é”™è¯¯ç ï¼š20029 redirect_uri è¯·æ±‚ä¸åˆæ³•
```

**åŸå› **ï¼šé£ä¹¦åº”ç”¨å®‰å…¨è®¾ç½®ä¸­çš„é‡å®šå‘ URL ä¸å®é™…è¯·æ±‚çš„ä¸åŒ¹é…ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. æ‰“å¼€ [ç«å±±å¼•æ“ç”¨æˆ·æ± æ§åˆ¶å°](https://console.volcengine.com/identity/region:identity+cn-beijing/user-pools)
2. è¿›å…¥ç”¨æˆ·æ± è¯¦æƒ…ï¼Œå¤åˆ¶ã€Œ**OAuth ç™»å½•å›è°ƒåœ°å€**ã€
3. å°†è¯¥åœ°å€æ·»åŠ åˆ°é£ä¹¦å¼€æ”¾å¹³å° â†’ ä½ çš„åº”ç”¨ â†’ ã€Œ**å®‰å…¨è®¾ç½®**ã€â†’ ã€Œ**é‡å®šå‘ URL**ã€
4. **ä¿å­˜å¹¶é‡æ–°å‘å¸ƒé£ä¹¦åº”ç”¨**

> âš ï¸ **å…³é”®**ï¼šé‡å®šå‘ URL å¿…é¡»ä»ç”¨æˆ·æ± æ§åˆ¶å°å¤åˆ¶ï¼Œä¸è¦è‡ªå·±æ‹¼æ¥ï¼

#### 5. å¤–éƒ¨èº«ä»½æä¾›å•†é…ç½®é”™è¯¯

**é”™è¯¯ä¿¡æ¯**ï¼š

```text
å¤–éƒ¨èº«ä»½æä¾›å•†é…ç½®é”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜å¤„ç†ã€‚
```

**åŸå› **ï¼šç”¨æˆ·æ± ä¸­é…ç½®çš„é£ä¹¦ IdPï¼ˆç”¨äº Inbound ç™»å½•ï¼‰çš„ App ID/Secret ä¸æ­£ç¡®ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. æ‰“å¼€ [ç”¨æˆ·æ± æ§åˆ¶å°](https://console.volcengine.com/identity/region:identity+cn-beijing/user-pools)
2. è¿›å…¥ç”¨æˆ·æ±  â†’ ã€Œ**å¤–éƒ¨èº«ä»½ä¾›åº”å•†**ã€â†’ ç¼–è¾‘é£ä¹¦ IdP
3. æ›´æ–°ä¸ºæ­£ç¡®çš„é£ä¹¦åº”ç”¨ **App ID** å’Œ **App Secret**
4. ä¿å­˜é…ç½®

#### 6. OAuth æˆæƒè½®è¯¢è¶…æ—¶ï¼ˆæˆæƒé¡µé¢èƒ½æ‰“å¼€ä½†æ— å“åº”ï¼‰

**é”™è¯¯ä¿¡æ¯**ï¼š

```text
OAuth2 auth polling timed out after 60 seconds. User may not have completed authorization.
```

**ç°è±¡**ï¼š

- ç‚¹å‡»æˆæƒé“¾æ¥åï¼ŒGitHub/é£ä¹¦æˆæƒé¡µé¢èƒ½æ­£å¸¸æ‰“å¼€
- é¡µé¢æ˜¾ç¤º "You are being redirected to the authorized application" æˆ–ç›´æ¥è·³è½¬
- ä½† Agent ä¸€ç›´åœ¨è½®è¯¢ï¼Œæœ€ç»ˆè¶…æ—¶

**åŸå› **ï¼š

ä¹‹å‰å·²ç»æˆæƒè¿‡è¯¥ OAuth Appï¼Œç¬¬ä¸‰æ–¹å¹³å°ï¼ˆGitHub/é£ä¹¦ï¼‰è®°ä½äº†æˆæƒçŠ¶æ€ï¼Œè‡ªåŠ¨è·³è¿‡ç¡®è®¤é¡µé¢ã€‚ä½† Agent Identity æœåŠ¡ç«¯å¯èƒ½ï¼š

- Token å·²è¿‡æœŸæˆ–è¢«æ’¤é”€
- å‡­è¯æä¾›è€…é…ç½®è¢«ä¿®æ”¹è¿‡ï¼ˆå¦‚ Client Secret æ›´æ–°ï¼‰
- State å‚æ•°ä¸åŒ¹é…å¯¼è‡´å›è°ƒè¢«æ‹’ç»

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. **æ’¤é”€ç¬¬ä¸‰æ–¹å¹³å°çš„æˆæƒ**ï¼š
   - GitHub: æ‰“å¼€ <https://github.com/settings/applications>ï¼Œæ‰¾åˆ°å¯¹åº”çš„ Appï¼Œç‚¹å‡» **Revoke**
   - é£ä¹¦: åœ¨é£ä¹¦å®¢æˆ·ç«¯ â†’ è®¾ç½® â†’ éšç§ â†’ æˆæƒç®¡ç† â†’ å–æ¶ˆæˆæƒ

2. **é‡æ–°åœ¨ Agent ä¸­è§¦å‘æˆæƒ**ï¼š
   - åœ¨ Agent å¯¹è¯æ¡†ä¸­å‘é€éœ€è¦æˆæƒçš„è¯·æ±‚
   - ç‚¹å‡»è¿”å›çš„æˆæƒé“¾æ¥
   - **åœ¨ 60 ç§’å†…**å®Œæˆæˆæƒç¡®è®¤

> âš ï¸ **æ³¨æ„**ï¼šå¿…é¡»åœ¨ Agent çš„è½®è¯¢çª—å£æœŸï¼ˆ60 ç§’ï¼‰å†…å®Œæˆæˆæƒï¼Œå¦åˆ™ä¼šè¶…æ—¶ã€‚

#### 7. GitHub OAuth App 404 é”™è¯¯

**é”™è¯¯ä¿¡æ¯**ï¼š

è®¿é—® GitHub æˆæƒé“¾æ¥æ—¶æ˜¾ç¤º GitHub 404 é¡µé¢ã€‚

**åŸå› **ï¼š

- GitHub OAuth App å·²è¢«åˆ é™¤
- Client ID é…ç½®é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. æ£€æŸ¥ [Agent Identity å‡­è¯æä¾›è€…](https://console.volcengine.com/identity/region:identity+cn-beijing/credential-providers) ä¸­çš„ Client ID
2. åœ¨ [GitHub Developer Settings](https://github.com/settings/developers) ç¡®è®¤ OAuth App å­˜åœ¨
3. å¦‚æœ App ä¸å­˜åœ¨ï¼Œéœ€è¦é‡æ–°åˆ›å»ºå¹¶æ›´æ–°å‡­è¯æä¾›è€…é…ç½®

### ğŸ”´ å›è°ƒ URL é…ç½®è¯¦è§£

Outbound å‡­è¯æ‰˜ç®¡æ¶‰åŠ **ä¸‰ä¸ªåœ°æ–¹** éœ€è¦é…ç½®å›è°ƒ URLï¼ŒåŠ¡å¿…åŒºåˆ†æ¸…æ¥šï¼š

| é…ç½®ä½ç½® | å›è°ƒ URL | ç”¨é€” |
|----------|----------|------|
| **1. é£ä¹¦å¼€æ”¾å¹³å°** â†’ å®‰å…¨è®¾ç½® | `https://auth.id.cn-beijing.volces.com/api/v1/oauth2callback` | é£ä¹¦æˆæƒåé‡å®šå‘ç›®æ ‡ |
| **2. Agent Identity** â†’ å‡­è¯æä¾›è€… | `https://auth.id.cn-beijing.volces.com/api/v1/oauth2callback` | Identity Service æ¥æ”¶ OAuth å›è°ƒ |
| **3. ä»£ç ä¸­ oauth2_auth()** | **ä¸éœ€è¦è®¾ç½®** | è®© Identity Service ä½¿ç”¨å‡­è¯æä¾›è€…é…ç½® |

> âš ï¸ **å…³é”®ç†è§£**ï¼šOAuth å›è°ƒæ˜¯ç”± **Identity Service** å¤„ç†çš„ï¼Œä¸æ˜¯ä½ çš„ Agent Runtimeï¼
>
> é£ä¹¦æˆæƒå â†’ é‡å®šå‘åˆ° Identity Service â†’ Identity Service æ¢å– Token å¹¶å­˜å‚¨ â†’ Agent è½®è¯¢è·å– Token

### é…ç½®æ£€æŸ¥æ¸…å•

- [ ] **é£ä¹¦åº”ç”¨æ˜¯å¦å·²å‘å¸ƒï¼Ÿ**
- [ ] **é£ä¹¦å®‰å…¨è®¾ç½®æ˜¯å¦æ·»åŠ äº†å›è°ƒ URLï¼Ÿ** `https://auth.id.cn-beijing.volces.com/api/v1/oauth2callback`
- [ ] **é£ä¹¦æƒé™æ˜¯å¦åŒ…å« `docx:document:readonly` å’Œ `drive:drive`ï¼Ÿ**
- [ ] **å‡­è¯æä¾›è€…å›è°ƒ URL æ˜¯å¦æ­£ç¡®ï¼Ÿ** `https://auth.id.cn-beijing.volces.com/api/v1/oauth2callback`
- [ ] **å‡­è¯æä¾›è€…æƒé™èŒƒå›´æ˜¯å¦æ­£ç¡®ï¼Ÿ** ä¸è¦ä½¿ç”¨ `openid`ï¼Œä½¿ç”¨é£ä¹¦ç‰¹å®š scope
- [ ] **å‡­è¯æä¾›è€… OAuth2 æµç¨‹æ˜¯å¦æ˜¯ USER_FEDERATIONï¼Ÿ**
- [ ] **æ˜¯å¦å·²éƒ¨ç½²åˆ° AgentKit Runtimeï¼Ÿ**

---

## è¿›é˜¶: æ”¯æŒæ›´å¤šç¬¬ä¸‰æ–¹æœåŠ¡

å‡­è¯æ‰˜ç®¡ä¸ä»…æ”¯æŒé£ä¹¦ï¼Œè¿˜å¯ä»¥é…ç½®ï¼š

- **Notion** - æ–‡æ¡£å’ŒçŸ¥è¯†åº“
- **Google Workspace** - æ—¥å†ã€é‚®ä»¶ã€æ–‡æ¡£
- **GitHub** - ä»£ç ä»“åº“
- **Slack** - å›¢é˜Ÿåä½œ
- **ç«å±±äº‘æœåŠ¡** - ECSã€å¯¹è±¡å­˜å‚¨ç­‰

é…ç½®æ–¹æ³•ç±»ä¼¼ï¼Œåœ¨æ§åˆ¶å°åˆ›å»ºå¯¹åº”çš„ Credential Provider å³å¯ã€‚

---

## æ ¸å¿ƒåŠŸèƒ½å›é¡¾


> "Agent Identity çš„å‡­è¯æ‰˜ç®¡åŠŸèƒ½ï¼Œè®©æ‚¨çš„æ™ºèƒ½ä½“å¯ä»¥ **å®‰å…¨æ— æ„Ÿ** åœ°è®¿é—®
> é£ä¹¦ã€Notion ç­‰å¤–éƒ¨å·¥å…·ï¼Œå‡­è¯ç”±å¹³å°ç»Ÿä¸€ç®¡ç†ï¼Œ**å‘Šåˆ« AK/SK æ³„éœ²é£é™©**ã€‚
>
> - **é›¶å‡­è¯ä»£ç **ï¼šä»£ç ä¸­ä¸å†å‡ºç°ä»»ä½•æ•æ„Ÿä¿¡æ¯
> - **ç”¨æˆ·çº§éš”ç¦»**ï¼šå¼ ä¸‰çš„é£ä¹¦æˆæƒä¸ä¼šè¢«æå››ä½¿ç”¨
> - **è‡ªåŠ¨åˆ·æ–°**ï¼šToken è¿‡æœŸè‡ªåŠ¨å¤„ç†ï¼Œç”¨æˆ·å®Œå…¨æ— æ„ŸçŸ¥
> - **ä¸€æ¬¡æˆæƒ**ï¼šç”¨æˆ·åªéœ€æˆæƒä¸€æ¬¡ï¼Œåç»­è®¿é—®å…¨è‡ªåŠ¨"

---

## ç›¸å…³èµ„æº

- [å®éªŒ1: ç”¨æˆ·æ± è®¤è¯](../tutorial-1-userpool-inbound/README.md) - åŸºç¡€æ•™ç¨‹
- [å®éªŒ2: é£ä¹¦IdPè”åˆç™»å½•](../tutorial-2-feishu-idp/README.md) - åŸºç¡€æ•™ç¨‹
- [é£ä¹¦å¼€æ”¾å¹³å°](https://open.feishu.cn/)
- [Agent Identity å‡­è¯æ‰˜ç®¡æ–‡æ¡£](https://www.volcengine.com/docs/identity/credential-provider)
- [AgentKit Runtime éƒ¨ç½²æŒ‡å—](https://volcengine.github.io/agentkit-sdk-python/content/4.runtime/1.runtime_quickstart.html)
