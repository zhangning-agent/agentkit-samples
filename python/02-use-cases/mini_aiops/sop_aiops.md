---

# 📘 **统一故障排查 SOP（Standard Operating Procedure）**

**适用范围**：云上业务、应用服务、主机、数据库、监控、链路追踪、安全事件
**工具集**：TLS-MCP、VMP-MCP、ECS Assistant、RDS-MySQL MCP、Sec-Agent、APMPlus-MCP

---

## 🧭 1. 总则

当出现以下异常情况时，应按照本 SOP 进行统一排查：

* 请求失败率提升、5xx 变高
* RT 延迟异常升高
* CPU / 内存 / IO / 网络 出现瓶颈
* 数据库响应变慢或锁等待
* 追踪链路出现异常 delay
* 安全事件或风险告警

排查顺序：

**日志 → 监控 → 主机 → 数据库 → 安全 → 链路追踪 → 根因定位**

---

## 📑 2. 日志排查（TLS-MCP）

### 2.1 触发条件

* 服务报错 / 请求失败
* 用户反馈异常行为
* 上游或下游返回错误

### 2.2 操作步骤

1. 通过 `tls.queryLogs` 查询日志
2. 按以下维度过滤：

   * 服务名
   * 环境（prod / staging）
   * 时间范围
   * 关键字：`error`, `exception`, `timeout`, `panic`
3. 提取可疑日志片段，标注异常节点
4. 若日志无法定位继续进入监控排查阶段

### 2.3 输出内容

* 错误类型描述
* 3 条以上关键日志
* 初步异常判断（业务逻辑 / 依赖接口 / 系统错误）

---

## 📊 3. 监控排查（VMP-MCP）

### 3.1 触发条件

* CPU/内存/Load 异常
* QPS、RT、Success Rate 波动
* 依赖调用错误率升高

### 3.2 操作步骤

1. 使用 `vmp.queryMetrics` 查询：

   * 系统指标：CPU/Mem/Load/IO/Network/Disk
   * 应用指标：QPS/RT/Error Rate
   * 集群指标：节点状态/容器状态
2. 检查异常趋势：

   * 5 分钟
   * 1 小时
   * 24 小时
3. 标记异常时间点

### 3.3 输出内容

* 异常指标列表
* 指标趋势分析
* 初步判断问题在主机/应用/数据库/网络？

---

## 🖥️ 4. 主机诊断（ECS Assistant）

### 4.1 触发条件

* 整机资源占用异常
* OOM、进程崩溃
* IO 或网络异常
* 主机层面引发业务波动

### 4.2 操作步骤

1. 执行 `ecs.assistant.diagnose`
2. 查看以下内容：

   * top 进程 CPU / Mem
   * OOM Kill
   * 网络丢包、延迟
   * IO 利用率
   * 文件系统使用情况
3. 判断是否主机层问题导致业务故障

### 4.3 输出内容

* 异常资源及值
* 异常进程
* 主机健康度结论

---

## 🗄️ 5. 数据库慢 SQL 排查（RDS-MySQL MCP）

### 5.1 触发条件

* API 延迟变大但 CPU 正常
* 数据库连接数升高
* SQL 阻塞、锁等待

### 5.2 操作步骤

1. 调用 `rds.mysql.querySlowLog`
2. 检查：

   * Top 慢 SQL
   * 执行次数
   * Rows examined
   * Lock Time
   * 是否全表扫描
3. 判断是否是 SQL 不佳、索引缺失、锁竞争等

### 5.3 输出内容

* Top 3 慢 SQL
* SQL/索引层问题描述
* 建议（加索引 / 改写 SQL / 调整连接池）

---

## 🛡️ 6. 安全风险排查（Sec-Agent）

### 6.1 触发条件

* 异常登录、端口访问、扫描行为
* 高危漏洞
* 可疑进程
* 账号滥用或行为异常

### 6.2 操作步骤

1. 执行 `sec.agent.scanRisk`
2. 查看以下风险：

   * SSH/控制台异常登录
   * 恶意程序
   * 异常网络通信
   * 高危漏洞（CVE）
   * 配置不合规
3. 如发现高危项，及时升级为安全 incident

### 6.3 输出内容

* 风险清单（高/中/低）
* 可能影响业务的风险项
* 修复优先级建议

---

## 🔍 7. 链路追踪（APMPlus-MCP）

### 7.1 触发条件

* 单请求延迟变长
* 多服务调用链不稳定
* 业务出现分布式瓶颈
* 下游服务响应慢但原因不明

### 7.2 操作步骤

1. 使用 `apmplus.queryTrace` 查询链路
2. 查看：

   * Span 耗时
   * 最大延迟点
   * 错误 span
   * 数据库/Redis/RPC 调用延迟
   * 等待队列情况（Queue Wait）
3. 确定瓶颈在应用、数据库、缓存或外部依赖

### 7.3 输出内容

* 最慢 Span
* 耗时链路图描述
* 初步推断瓶颈原因

---

## 🧩 8. 根因分析（RCA）

整合上述信息，判断根因为：

| 层级   | 示例根因                 |
| ---- | -------------------- |
| 应用层  | 代码异常、线程池耗尽、连接池满、错误逻辑 |
| 主机层  | CPU 过高、IO 饱和、网络问题    |
| 数据库层 | 慢 SQL、锁等待、索引缺失       |
| 网络层  | DNS、带宽、跨可用区延迟        |
| 安全层  | 恶意请求、账号滥用、病毒         |
| 依赖层  | 第三方 API 异常、下游服务慢     |
| 调度层  | 容器重启、Pod 驱逐、调度不均     |

---

## 🛠️ 9. 修复与验证

### 9.1 执行修复方案

* 热修复应用
* 扩缩容
* 优化 SQL
* 清理主机资源
* 屏蔽攻击 IP
* 调整配置、索引或缓存策略

### 9.2 验证修复效果

* 指标恢复正常
* 日志无异常
* Trace 延迟恢复
* 重新请求验证链路
* 数据库负载下降

---

## 📝 10. 事件记录（Incident Record）

每次排查必须记录以下内容：

* 时间线（Timeline）
* 影响范围
* Root Cause
* 处理步骤
* 指标截图/日志截图
* 预防措施（Action Items）

---

如需，我可以进一步生成：

🔧 **版本包含工具调用示例（具体 MCP JSON 调用示例）**
📄 **企业内审版带编号的 ISO 风格 SOP**
📦 **将 SOP 导出为 PDF/Word 版本**
🧭 **对应的自动巡检脚本（Python/Go）**

需要哪个版本？